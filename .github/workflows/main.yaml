name: Publish Helm Chart to Harbor

on:
  push:
    branches:
      - main   # jab bhi main branch par push hoga, ye action chalega

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0   # Helm version
      



      #

# ...existing code...
      - name: Update appVersion and version in Chart.yaml
        run: |
          NEW_APP_VERSION=$(git rev-parse --short HEAD)
          COMMIT_COUNT=$(git rev-list --count HEAD)
          NEW_CHART_VERSION="1.0.${COMMIT_COUNT}"
          yq -i '.appVersion = strenv(NEW_APP_VERSION)' ./my-app/Chart.yaml
          yq -i '.version = strenv(NEW_CHART_VERSION)' ./my-app/Chart.yaml
# ...existing code...

      - name: Show updated Chart.yaml
        run: cat ./my-app/Chart.yaml

      - name: Package Helm Chart
        run: |
          helm dependency update ./my-app
          helm package ./my-app -d .
        

      
      - name: Push to Harbor
        env:
          HARBOR_URL: ${{ secrets.HARBOR_URL }}
          HARBOR_PROJECT: ${{ secrets.HARBOR_PROJECT }}
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          echo $HARBOR_PASSWORD | helm registry login $HARBOR_URL --username $HARBOR_USERNAME --password-stdin
          helm push *.tgz oci://$HARBOR_URL/$HARBOR_PROJECT
      
